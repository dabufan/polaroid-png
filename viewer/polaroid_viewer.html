<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Polaroid PNG Viewer</title>
<style>
  body{font-family:system-ui;margin:0;min-height:100vh;display:grid;place-items:center;background:#f3f4f6;}
  .scene{width:360px;height:520px;perspective:1200px;}
  .card{width:100%;height:100%;position:relative;transform-style:preserve-3d;
        transition:transform 600ms cubic-bezier(.2,.7,.1,1);}
  .card.is-back{transform:rotateY(180deg);}
  .face{position:absolute;inset:0;backface-visibility:hidden;border-radius:16px;overflow:hidden;
        background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.18);}
  .back{transform:rotateY(180deg);}
  .hit{position:absolute;top:0;bottom:0;width:50%;z-index:5;cursor:pointer;}
  .hit.left{left:0;} .hit.right{right:0;}
  img{width:100%;height:100%;object-fit:cover;display:block;}
  .wrap{display:grid;gap:12px;place-items:center;}
  .meta{width:360px;font-size:14px;color:#333;background:#fff;border-radius:10px;padding:8px 10px;box-shadow:0 6px 16px rgba(0,0,0,.08);}
</style>
</head>
<body>
<div class="wrap">
  <input id="file" type="file" accept=".png"/>
  <div class="scene">
    <div id="card" class="card">
      <div class="hit left" id="hitLeft"></div>
      <div class="hit right" id="hitRight"></div>

      <div class="face front"><img id="frontImg"></div>
      <div class="face back"><img id="backImg"></div>
    </div>
  </div>
  <pre id="meta" class="meta">meta: (none)</pre>
</div>

<script>
const card = document.getElementById("card");
document.getElementById("hitLeft").onclick = () => card.classList.add("is-back");
document.getElementById("hitRight").onclick = () => card.classList.remove("is-back");

const PNG_SIG = [0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A];
const COMP_RAW=0, COMP_RLE=1;

function readU32BE(view, off){ return view.getUint32(off, false); }
function isPNG(u8){
  for(let i=0;i<8;i++) if(u8[i]!==PNG_SIG[i]) return false;
  return true;
}
function rleDecode(bytes, expected){
  let out=[], i=0;
  while(i<bytes.length && out.length<expected){
    const h=bytes[i++], isRun=(h&0x80)!==0, len=(h&0x7f)+1;
    if(isRun){
      const v=bytes[i++]; for(let k=0;k<len;k++) out.push(v);
    }else{
      for(let k=0;k<len;k++) out.push(bytes[i++]);
    }
  }
  if(out.length!==expected) throw new Error("RLE mismatch");
  return new Uint8Array(out);
}
function rawToImageURL({w,h,ch,raw}){
  const canvas=document.createElement("canvas");
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext("2d");
  const imgData=ctx.createImageData(w,h);

  if(ch===4) imgData.data.set(raw);
  else if(ch===3){
    for(let i=0,j=0;i<raw.length;i+=3,j+=4){
      imgData.data[j]=raw[i];
      imgData.data[j+1]=raw[i+1];
      imgData.data[j+2]=raw[i+2];
      imgData.data[j+3]=255;
    }
  }else{
    for(let i=0,j=0;i<raw.length;i++,j+=4){
      const v=raw[i];
      imgData.data[j]=v; imgData.data[j+1]=v; imgData.data[j+2]=v; imgData.data[j+3]=255;
    }
  }
  ctx.putImageData(imgData,0,0);
  return canvas.toDataURL();
}

function parsePOLR(dataU8){
  if(isPNG(dataU8)){
    return {version:1, backPNG:dataU8};
  }
  const view = new DataView(dataU8.buffer, dataU8.byteOffset, dataU8.byteLength);
  let off=0;
  const ver=view.getUint8(off++);
  const ch=view.getUint8(off++), bpc=view.getUint8(off++), comp=view.getUint8(off++);
  const w=view.getUint16(off,false); off+=2;
  const h=view.getUint16(off,false); off+=2;
  const rawSize=view.getUint32(off,false); off+=4;
  const compSize=view.getUint32(off,false); off+=4;
  off+=4; // crc32_raw

  const compPixels = new Uint8Array(dataU8.buffer, dataU8.byteOffset+off, compSize);
  let raw;
  if(comp===COMP_RLE) raw=rleDecode(compPixels, rawSize);
  else raw=compPixels;

  return {version:2, w,h,ch,bpc, raw};
}

function parsePolaroidPNG(ab){
  const u8 = new Uint8Array(ab);
  for(let i=0;i<8;i++) if(u8[i]!==PNG_SIG[i]) throw new Error("not png");
  const view=new DataView(ab);
  let off=8;
  let polr=null, meta=null;

  while(off+8<=ab.byteLength){
    const len=readU32BE(view,off); off+=4;
    const type=String.fromCharCode(...u8.slice(off,off+4)); off+=4;
    const data=u8.slice(off,off+len); off+=len;
    off+=4; // crc

    if(type==="pOLR") polr=parsePOLR(data);
    if(type==="pMET"){
      const mv=new DataView(data.buffer, data.byteOffset, data.byteLength);
      const fmt=mv.getUint32(0,false);
      const tlen=mv.getUint32(4,false);
      const textBytes=data.slice(8,8+tlen);
      const text=new TextDecoder().decode(textBytes);
      meta=JSON.parse(text);
    }
    if(type==="IEND") break;
  }
  return {polr, meta};
}

document.getElementById("file").addEventListener("change", async (e)=>{
  const file=e.target.files[0];
  if(!file) return;
  const ab=await file.arrayBuffer();

  document.getElementById("frontImg").src = URL.createObjectURL(file);

  let parsed;
  try{ parsed=parsePolaroidPNG(ab); }
  catch(err){ alert(err.message); return; }

  if(parsed.polr){
    if(parsed.polr.version===1){
      const blob=new Blob([parsed.polr.backPNG],{type:"image/png"});
      document.getElementById("backImg").src=URL.createObjectURL(blob);
    }else{
      document.getElementById("backImg").src=rawToImageURL(parsed.polr);
    }
  }else{
    document.getElementById("backImg").src="";
  }

  document.getElementById("meta").textContent =
    "meta: " + (parsed.meta ? JSON.stringify(parsed.meta,null,2) : "(none)");
});
</script>
</body>
</html>
